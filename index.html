<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Vitesse Muscu ‚Äî Simple</title>
  <style>
    :root {
      --bg: #000000; --card: #1c1c1e; --text: #ffffff;
      --accent: #0a84ff; --success: #30d158; --danger: #ff453a; --muted: #8e8e93;
      --border: #38383a;
    }
    body {
      margin: 0; padding: 20px 16px;
      background: var(--bg); color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      text-align: center;
      padding-bottom: 50px;
    }

    /* --- LAYOUT --- */
    h1 { font-size: 16px; font-weight: 600; color: var(--muted); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
    
    .main-display {
      margin: 20px 0;
    }
    .value-box {
      font-size: 72px; font-weight: 800;
      line-height: 1; font-variant-numeric: tabular-nums;
      margin-bottom: 5px;
    }
    .label-box { font-size: 18px; color: var(--muted); }
    
    .status-pill {
      display: inline-block; padding: 6px 12px;
      border-radius: 20px; font-size: 13px; font-weight: 600;
      background: var(--card); color: var(--muted);
      margin-bottom: 20px;
    }
    .status-pill.active { background: rgba(10, 132, 255, 0.2); color: var(--accent); }
    .status-pill.done { background: rgba(48, 209, 88, 0.2); color: var(--success); }

    /* --- CONTROLS --- */
    .controls {
      background: var(--card); border-radius: 20px; padding: 20px;
      margin-bottom: 20px; border: 1px solid var(--border);
    }
    .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .input-group { flex: 1; }
    label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px; text-align: left; }
    input, select {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      color: white; padding: 10px; border-radius: 10px; font-size: 16px;
      text-align: center; box-sizing: border-box;
    }

    /* --- BUTTONS --- */
    button {
      width: 100%; padding: 16px; border-radius: 14px; border: none;
      font-size: 17px; font-weight: 700; cursor: pointer;
      transition: transform 0.1s;
    }
    button:active { transform: scale(0.96); }
    
    .btn-start { background: var(--accent); color: white; }
    .btn-valid { background: var(--success); color: black; margin-bottom: 10px; }
    .btn-discard { background: var(--card); color: var(--danger); border: 1px solid var(--border); }
    .hidden { display: none !important; }

    /* --- GRAPH & TABLE --- */
    .chart-container {
      background: var(--card); border-radius: 16px; padding: 15px;
      margin-bottom: 20px; border: 1px solid var(--border);
    }
    canvas { width: 100%; height: 200px; display: block; }
    
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
    th { color: var(--muted); text-align: left; padding: 8px; border-bottom: 1px solid var(--border); }
    td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
    .num { text-align: right; }

    .instructions { font-size: 12px; color: var(--muted); margin-top: 30px; line-height: 1.4; }
  </style>
</head>
<body>

  <h1>Vitesse Muscu</h1>

  <div id="statusPill" class="status-pill">En attente</div>

  <div class="main-display">
    <div id="bigValue" class="value-box">0.00</div>
    <div class="label-box">m/s</div>
  </div>

  <div class="controls">
    <div class="input-row">
      <div class="input-group">
        <label>Exercice</label>
        <select id="exSelect">
          <option>Squat</option>
          <option>Bench</option>
          <option>Deadlift</option>
        </select>
      </div>
      <div class="input-group">
        <label>Charge (kg)</label>
        <input type="number" id="loadInput" value="60">
      </div>
    </div>

    <div id="startZone">
      <button class="btn-start" id="btnStart">√âcouter (Start)</button>
    </div>

    <div id="validZone" class="hidden">
      <button class="btn-valid" id="btnSave">Valider</button>
      <button class="btn-discard" id="btnRetry">Ignorer / Refaire</button>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="myChart"></canvas>
  </div>

  <div class="chart-container">
    <table id="histTable">
      <thead><tr><th>Set</th><th>Kg</th><th class="num">m/s</th><th class="num">W</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:10px; text-align:right;">
      <button onclick="resetData()" style="background:transparent; color:var(--danger); font-size:12px; width:auto; padding:5px;">Tout effacer</button>
    </div>
  </div>

  <div class="instructions">
    1. Fixe le t√©l√©phone. 2. Appuie sur "√âcouter".<br>
    3. Fais ta rep. L'appli d√©tecte la fin et t'affiche le score.<br>
    4. Valide pour ajouter au graphique.
    <br><br>
    <i>Note : Sur iPhone, utilise Safari et autorise les capteurs.</i>
  </div>

<script>
// --- CONFIG ---
const THRESHOLD_START = 0.6; // Sensibilit√© d√©clenchement
const THRESHOLD_STOP = 0.3;  // Sensibilit√© arr√™t
const TIME_HOLD_STOP = 300;  // Dur√©e (ms) stable pour consid√©rer la rep finie

// --- STATE ---
let isListening = false;
let inRep = false;
let startTime = 0;
let stopTimer = null;
let maxSpeed = 0;
let currentSpeed = 0;
let accSmooth = 0;

let historyData = [];

// --- DOM ---
const ui = {
  val: document.getElementById('bigValue'),
  status: document.getElementById('statusPill'),
  startZone: document.getElementById('startZone'),
  validZone: document.getElementById('validZone'),
  btnStart: document.getElementById('btnStart'),
  btnSave: document.getElementById('btnSave'),
  btnRetry: document.getElementById('btnRetry'),
  table: document.querySelector('#histTable tbody'),
  load: document.getElementById('loadInput'),
  canvas: document.getElementById('myChart')
};

// --- LOGIQUE MOUVEMENT ---
function processMotion(event) {
  if (!isListening) return;

  // Lecture capteur (avec support gravit√© Android/iOS)
  const acc = event.acceleration;
  const accG = event.accelerationIncludingGravity;
  let ax = 0, ay = 0, az = 0;

  if (acc && acc.x != null) {
    ax = acc.x; ay = acc.y; az = acc.z;
  } else if (accG) {
    // Filtre passe-haut rudimentaire si pas de linear_acceleration
    ax = accG.x; ay = accG.y; az = accG.z - 9.81; 
  }

  // Magnitude absolue (on se fiche de l'orientation)
  const rawMag = Math.sqrt(ax*ax + ay*ay + az*az);
  
  // Lissage (Low pass filter) pour √©viter le bruit
  accSmooth = accSmooth * 0.8 + rawMag * 0.2;

  const now = performance.now();
  // Int√©gration Vitesse (simplifi√©e)
  // Drift decay : la vitesse redescend doucement vers 0 si pas de mouvement
  currentSpeed = (currentSpeed * 0.95) + (accSmooth * 0.016); 
  if (currentSpeed < 0.05) currentSpeed = 0;

  // --- MACHINE A ETATS ---
  
  if (!inRep) {
    // Phase d'attente
    if (accSmooth > THRESHOLD_START) {
      inRep = true;
      maxSpeed = 0;
      ui.status.textContent = "üî• En cours...";
      ui.status.className = "status-pill active";
      ui.val.style.color = "#0a84ff"; // Bleu
    }
    // Affiche 0 ou bruit de fond l√©ger
    ui.val.textContent = currentSpeed.toFixed(2);
  } 
  else {
    // Phase de r√©p√©tition active
    if (currentSpeed > maxSpeed) maxSpeed = currentSpeed;
    ui.val.textContent = currentSpeed.toFixed(2);

    // D√©tection fin
    if (accSmooth < THRESHOLD_STOP) {
      if (!stopTimer) stopTimer = now;
      if (now - stopTimer > TIME_HOLD_STOP) {
        // C'EST FINI
        finishRep();
      }
    } else {
      stopTimer = null;
    }
  }
}

function finishRep() {
  isListening = false;
  inRep = false;
  stopTimer = null;
  currentSpeed = 0;
  
  // Afficher le r√©sultat fig√©
  ui.val.textContent = maxSpeed.toFixed(2);
  ui.val.style.color = "#30d158"; // Vert
  ui.status.textContent = "Termin√©";
  ui.status.className = "status-pill done";

  // Changer les boutons
  ui.startZone.classList.add('hidden');
  ui.validZone.classList.remove('hidden');
}

// --- BOUTONS ---

ui.btnStart.addEventListener('click', async () => {
  // Permission iOS
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    try { await DeviceMotionEvent.requestPermission(); } catch (e) {}
  }

  // Reset UI
  ui.startZone.classList.remove('hidden');
  ui.validZone.classList.add('hidden');
  ui.val.style.color = "white";
  ui.val.textContent = "0.00";
  ui.status.textContent = "√âcoute...";
  ui.status.className = "status-pill active";
  
  isListening = true;
  inRep = false;
  accSmooth = 0;
  currentSpeed = 0;
  
  window.addEventListener('devicemotion', processMotion, {passive: true});
});

ui.btnSave.addEventListener('click', () => {
  // Sauvegarde
  const load = parseFloat(ui.load.value) || 0;
  const power = Math.round(load * 9.81 * maxSpeed); // Approx P = F*v
  
  historyData.push({
    id: historyData.length + 1,
    load: load,
    v: maxSpeed,
    p: power
  });
  
  updateTable();
  updateChart();
  
  // Retour √† l'√©tat initial
  ui.val.textContent = "0.00";
  ui.val.style.color = "white";
  ui.status.textContent = "En attente";
  ui.status.className = "status-pill";
  ui.validZone.classList.add('hidden');
  ui.startZone.classList.remove('hidden');
  isListening = false;
});

ui.btnRetry.addEventListener('click', () => {
  // On jette et on recommence
  ui.val.textContent = "0.00";
  ui.val.style.color = "white";
  ui.status.textContent = "En attente";
  ui.status.className = "status-pill";
  ui.validZone.classList.add('hidden');
  ui.startZone.classList.remove('hidden');
  isListening = false;
});

// --- TABLEAU & GRAPHIQUE ---

function updateTable() {
  ui.table.innerHTML = "";
  // Afficher les derniers en haut
  [...historyData].reverse().forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>#${row.id}</td>
      <td>${row.load}</td>
      <td class="num"><strong>${row.v.toFixed(2)}</strong></td>
      <td class="num">${row.p}</td>
    `;
    ui.table.appendChild(tr);
  });
}

function updateChart() {
  const ctx = ui.canvas.getContext('2d');
  const w = ui.canvas.width = ui.canvas.offsetWidth;
  const h = ui.canvas.height = 200;
  
  // Reset
  ctx.clearRect(0,0,w,h);
  if(historyData.length < 1) return;

  const pad = 30;
  const gw = w - pad * 2;
  const gh = h - pad * 2;

  // Calcul √©chelles
  const maxV = Math.max(...historyData.map(d=>d.v)) * 1.2 || 1;
  const maxRep = historyData.length;

  // Lignes de fond
  ctx.strokeStyle = "#38383a";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad);
  ctx.stroke();

  // Tracer la ligne
  ctx.strokeStyle = "#0a84ff";
  ctx.lineWidth = 3;
  ctx.beginPath();
  
  historyData.forEach((d, i) => {
    // X : r√©parti uniform√©ment
    const x = pad + (i / (maxRep > 1 ? maxRep - 1 : 1)) * gw;
    // Y : Vitesse
    const y = (h - pad) - (d.v / maxV) * gh;
    
    if (i===0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
    
    // Points
    // On dessine apr√®s pour ne pas casser le path, ou on fait une 2eme passe
  });
  ctx.stroke();

  // Dessiner les points
  ctx.fillStyle = "#0a84ff";
  historyData.forEach((d, i) => {
    const x = pad + (i / (maxRep > 1 ? maxRep - 1 : 1)) * gw;
    const y = (h - pad) - (d.v / maxV) * gh;
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI*2);
    ctx.fill();
  });
}

function resetData() {
  if(confirm("Tout effacer ?")) {
    historyData = [];
    updateTable();
    updateChart();
  }
}
</script>
</body>
</html>
