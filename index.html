<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Vitesse Muscu - Debug</title>
  <style>
    :root { --bg:#0f172a; --card:#1e293b; --text:#f8fafc; --accent:#3b82f6; --valid:#22c55e; }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; }
    
    .card { background: var(--card); padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 1px solid #334155; }
    .big { font-size: 80px; font-weight: 800; margin: 10px 0; font-variant-numeric: tabular-nums; }
    
    button { width: 100%; padding: 20px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
    .btn-blue { background: var(--accent); color: white; }
    .btn-green { background: var(--valid); color: white; display: none; }
    
    #debug { font-family: monospace; font-size: 12px; color: #f59e0b; margin-top: auto; white-space: pre-wrap; word-break: break-all; border-top: 1px solid #333; padding-top: 10px; }
  </style>
</head>
<body>

  <div style="text-align:center; margin-bottom:20px;">
    <h3>Test Capteurs</h3>
    <div style="color:#94a3b8; font-size:14px;">Secouez le téléphone pour tester</div>
  </div>

  <div class="card">
    <div style="color:#94a3b8; font-size:12px;">VITESSE MAX</div>
    <div id="val" class="big">0.00</div>
    <div style="color:#94a3b8;">m/s</div>
  </div>

  <button id="btnStart" class="btn-blue">ACTIVER CAPTEURS</button>
  <button id="btnVal" class="btn-green">VALIDER (Reset)</button>

  <div id="debug">En attente d'activation...</div>

<script>
const btnStart = document.getElementById('btnStart');
const btnVal = document.getElementById('btnVal');
const valEl = document.getElementById('val');
const debugEl = document.getElementById('debug');

let maxV = 0;
let v = 0;
let lastT = 0;
let active = false;

// Variables pour retirer la gravité
let grav = { x: 0, y: 0, z: 0 };

btnStart.addEventListener('click', async () => {
  // 1. Demande explicite iOS
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    try {
      const response = await DeviceMotionEvent.requestPermission();
      if (response === 'granted') {
        start();
      } else {
        alert("Permission refusée par l'iPhone. Allez dans Réglages > Safari > Effacer historique et données pour réinitialiser le choix.");
      }
    } catch (e) {
      alert("Erreur technique : " + e);
    }
  } else {
    // Android ou vieux iOS
    start();
  }
});

function start() {
  window.addEventListener('devicemotion', handleMotion, true);
  btnStart.style.display = 'none';
  active = true;
  debugEl.textContent = "Capteurs actifs. Bougez le téléphone !";
}

function handleMotion(event) {
  if (!active) return;

  // Récupération des données brutes
  let ax = event.acceleration.x;
  let ay = event.acceleration.y;
  let az = event.acceleration.z;
  
  // Si 'acceleration' est null (certains Androids), on utilise 'accelerationIncludingGravity'
  let source = "ACCEL";
  if (ax === null && event.accelerationIncludingGravity) {
    source = "GRAV_FALLBACK";
    const g = event.accelerationIncludingGravity;
    // Filtre passe-bas simple pour isoler la gravité
    grav.x = grav.x * 0.9 + g.x * 0.1;
    grav.y = grav.y * 0.9 + g.y * 0.1;
    grav.z = grav.z * 0.9 + g.z * 0.1;
    
    ax = g.x - grav.x;
    ay = g.y - grav.y;
    az = g.z - grav.z;
  }

  // Calcul vecteur total
  const a = Math.sqrt(ax*ax + ay*ay + az*az);

  // DEBUG : Affichage en direct des valeurs brutes
  // Si ça reste à 0 ici, c'est que le téléphone ne donne rien.
  debugEl.textContent = `Source: ${source}\nX: ${ax?.toFixed(2)}\nY: ${ay?.toFixed(2)}\nZ: ${az?.toFixed(2)}\nTotal A: ${a.toFixed(2)}`;

  // Calcul Vitesse (Intégration simple)
  const now = performance.now();
  const dt = (now - lastT) / 1000;
  lastT = now;
  if (dt > 1) return; // Ignore les sauts de temps

  // Seuil abaissé à 0.5 pour le test (très sensible)
  if (a > 0.5) { 
    v += a * dt;
    if (v > maxV) {
      maxV = v;
      valEl.textContent = maxV.toFixed(2);
      valEl.style.color = "#22c55e"; // Vert
      btnVal.style.display = 'block';
    }
  } else {
    // Retour au calme
    v *= 0.9; // Friction
  }
}

btnVal.addEventListener('click', () => {
  maxV = 0;
  v = 0;
  valEl.textContent = "0.00";
  valEl.style.color = "#f8fafc";
  btnVal.style.display = 'none';
});

</script>
</body>
</html>
