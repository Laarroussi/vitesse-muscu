<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>VBT iPhone ‚Äî vitesse/power + 1RM</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --border:#e2e8f0; --accent:#2563eb; --accent2:#0ea5e9;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --shadow: 0 10px 24px rgba(2,6,23,.08);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0b0d10; --card:#121722; --text:#e9eef5; --muted:#9aa7bd;
      --border:#263249; --accent:#1e6bff; --accent2:#22c3ff;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:980px; margin:0 auto; padding:16px; padding-bottom:26px; }
    header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    h1{ font-size:18px; margin:0 0 6px; letter-spacing:-.01em; }
    .muted{ color:var(--muted); font-size:12.5px; line-height:1.35; }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:16px; padding:14px; box-shadow:var(--shadow);
    }
    .row{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width: 860px){ .row{ grid-template-columns: 1.15fr .85fr; } }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      border:0; border-radius:12px; padding:10px 12px;
      font-weight:650; cursor:pointer; font-size:14px;
      background:var(--accent); color:white;
    }
    button.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); }
    button.danger{ background:var(--bad); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:transparent;
      color:var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#94a3b8; }
    .dot.ok{ background:var(--ok); }
    .dot.warn{ background:var(--warn); }
    .dot.bad{ background:var(--bad); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 420px){
      .grid2{ grid-template-columns: 1fr; }
      .grid3{ grid-template-columns: 1fr; }
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:2px 0 6px; }
    input, select{
      width:100%; box-sizing:border-box;
      background:transparent; color:var(--text);
      border:1px solid var(--border); border-radius:12px;
      padding:10px 12px; font-size:14px; outline:none;
    }
    input:focus, select:focus{ border-color:var(--accent2); }

    .metricBig{
      border:1px solid var(--border); border-radius:16px;
      padding:12px; background:transparent;
    }
    .metricBig .k{ font-size:12px; color:var(--muted); }
    .metricBig .v{ font-size:44px; font-weight:850; letter-spacing:-.02em; }
    .metricBig .u{ font-size:14px; color:var(--muted); margin-left:6px; }
    .metricSmall{
      border:1px solid var(--border); border-radius:14px;
      padding:10px; background:transparent;
    }
    .metricSmall .k{ font-size:12px; color:var(--muted); }
    .metricSmall .v{ font-size:20px; font-weight:750; }

    .proposal{
      border:1px dashed var(--border); border-radius:16px;
      padding:12px; background:transparent;
    }
    .proposal h2{ margin:0 0 8px; font-size:14px; }
    .canvasWrap{
      border:1px solid var(--border); border-radius:16px; padding:10px;
      background:transparent;
    }
    canvas{ width:100%; height:260px; display:block; }

    details summary{
      cursor:pointer; color:var(--muted); font-weight:650; font-size:13px;
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:12.5px; }
    th,td{ border-bottom:1px solid var(--border); padding:8px 6px; text-align:left; }
    th{ color:var(--muted); font-weight:650; }
    .right{ text-align:right; }
    .topline{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .toggle{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--border); border-radius:999px;
      padding:6px 10px; cursor:pointer; user-select:none;
      color:var(--muted); font-size:12px;
    }
  </style>
</head>

<body>
<div class="wrap" id="app" data-theme="light">
  <header>
    <div>
      <h1>VBT iPhone ‚Äî vitesse / puissance + estimation 1RM</h1>
      <div class="muted">
        Safari + HTTPS obligatoire. Apr√®s <b>D√©marrer</b>, autorise ‚ÄúMouvement & Orientation‚Äù.
        Fin de rep = <b>proposition</b> (√† valider/rejeter).
      </div>
    </div>
    <div class="toggle" id="themeToggle" title="Basculer clair/sombre">‚òÄÔ∏è/üåô Th√®me</div>
  </header>

  <div class="row" style="margin-top:12px;">
    <!-- LIVE -->
    <div class="card">
      <div class="topline">
        <div class="btnRow">
          <button id="btnStart">D√©marrer</button>
          <button id="btnStop" class="secondary" disabled>Stop</button>
          <span class="pill"><span id="statusDot" class="dot"></span><span id="statusText">En attente</span></span>
          <span class="pill">Rep valid√©es : <b id="repCount">0</b></span>
        </div>
      </div>

      <div style="margin-top:10px;" class="metricBig">
        <div class="k">Vitesse PIC (bloqu√©e sur la meilleure valeur)</div>
        <div><span class="v" id="vHold">0.00</span><span class="u">m/s</span></div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div class="metricSmall">
          <div class="k">Vitesse moyenne (rep)</div>
          <div class="v" id="vMeanLive">‚Äî</div>
        </div>
        <div class="metricSmall">
          <div class="k">Acc√©l√©ration PIC (rep)</div>
          <div class="v" id="aPeakLive">‚Äî</div>
        </div>
        <div class="metricSmall">
          <div class="k">√âtat</div>
          <div class="v" id="repState">‚Äî</div>
        </div>
      </div>

      <div id="proposalBox" class="proposal" style="margin-top:12px; display:none;">
        <h2>Proposition (non enregistr√©e)</h2>
        <div class="grid2">
          <div class="muted" id="proposalText"></div>
          <div class="btnRow" style="justify-content:flex-end;">
            <button id="btnReject" class="secondary">Rejeter</button>
            <button id="btnAccept">Valider</button>
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        ‚ö†Ô∏è Estimation via acc√©l√©rom√®tre (sensibilit√© vibrations/fixation). Pour une vraie VBT bar velocity, un capteur d√©di√© est pr√©f√©rable.
      </div>
    </div>

    <!-- SETTINGS + RESULTS -->
    <div class="card">
      <div class="grid2">
        <div>
          <label for="exercise">Exercice</label>
          <select id="exercise">
            <option value="bench">Bench press</option>
            <option value="squat">Back squat</option>
            <option value="row">Bent-over row</option>
            <option value="deadlift">Deadlift</option>
            <option value="other">Autre</option>
          </select>
        </div>
        <div>
          <label for="loadKg">Charge (kg)</label>
          <input type="number" id="loadKg" value="20" step="2.5" min="0" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label for="axisMode">Signal</label>
          <select id="axisMode">
            <option value="mag" selected>Magnitude (robuste)</option>
            <option value="x">Axe X</option>
            <option value="y">Axe Y</option>
            <option value="z">Axe Z</option>
          </select>
        </div>
        <div>
          <label for="mvt">MVT (m/s) pour 1RM (modifiable)</label>
          <input type="number" id="mvt" value="0.17" step="0.01" min="0" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div class="metricSmall">
          <div class="k">1RM estim√©e (profil charge‚Äìvitesse)</div>
          <div class="v" id="oneRm">‚Äî</div>
          <div class="muted" id="oneRmHint" style="margin-top:4px;"></div>
        </div>
        <div class="metricSmall">
          <div class="k">Puissance max (valid√©e)</div>
          <div class="v" id="pMax">‚Äî</div>
          <div class="muted" id="pMaxHint" style="margin-top:4px;"></div>
        </div>
      </div>

      <div class="canvasWrap" style="margin-top:10px;">
        <div class="muted" style="margin-bottom:6px;">Graphique (x=charge | y=gauche=vitesse | y=droite=puissance)</div>
        <canvas id="chart" width="900" height="520"></canvas>
      </div>

      <details style="margin-top:10px;">
        <summary>R√©glages avanc√©s + tableau + export</summary>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label for="startThr">Seuil d√©but rep (m/s¬≤)</label>
            <input type="number" id="startThr" value="0.60" step="0.05" min="0" />
          </div>
          <div>
            <label for="stopThr">Seuil fin rep (m/s¬≤)</label>
            <input type="number" id="stopThr" value="0.25" step="0.05" min="0" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label for="stopHold">Temps bas pour finir (ms)</label>
            <input type="number" id="stopHold" value="250" step="50" min="50" />
          </div>
          <div>
            <label for="decayTau">Anti-d√©rive vitesse (s)</label>
            <input type="number" id="decayTau" value="0.35" step="0.05" min="0.05" />
          </div>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button id="btnExport" class="secondary">Exporter CSV</button>
          <button id="btnUndo" class="secondary">Supprimer derni√®re</button>
          <button id="btnReset" class="danger">Reset set</button>
        </div>

        <div class="muted" style="margin-top:8px;">
          Conseil iPhone : partager ‚Üí ‚ÄúAjouter √† l‚Äô√©cran d‚Äôaccueil‚Äù.
        </div>

        <table>
          <thead>
          <tr>
            <th>#</th>
            <th>Exo</th>
            <th class="right">kg</th>
            <th class="right">vÃÑ (m/s)</th>
            <th class="right">v pic</th>
            <th class="right">a pic</th>
            <th class="right">PÃÑ (W)</th>
            <th class="right">P pic</th>
            <th class="right">dur (s)</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </details>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- DOM helpers ----------
  const $ = (id) => document.getElementById(id);

  const app = $("app");
  const btnStart = $("btnStart");
  const btnStop = $("btnStop");
  const btnAccept = $("btnAccept");
  const btnReject = $("btnReject");
  const btnExport = $("btnExport");
  const btnReset = $("btnReset");
  const btnUndo = $("btnUndo");
  const themeToggle = $("themeToggle");

  const statusDot = $("statusDot");
  const statusText = $("statusText");
  const repCountEl = $("repCount");

  const vHoldEl = $("vHold");
  const vMeanLiveEl = $("vMeanLive");
  const aPeakLiveEl = $("aPeakLive");
  const repStateEl = $("repState");

  const exerciseEl = $("exercise");
  const loadKgEl = $("loadKg");
  const axisModeEl = $("axisMode");
  const mvtEl = $("mvt");

  const startThrEl = $("startThr");
  const stopThrEl = $("stopThr");
  const stopHoldEl = $("stopHold");
  const decayTauEl = $("decayTau");

  const proposalBox = $("proposalBox");
  const proposalText = $("proposalText");

  const tbody = $("tbody");
  const canvas = $("chart");
  const ctx = canvas.getContext("2d");

  const oneRmEl = $("oneRm");
  const oneRmHintEl = $("oneRmHint");
  const pMaxEl = $("pMax");
  const pMaxHintEl = $("pMaxHint");

  // ---------- Literature-based defaults (indicative) ----------
  const EXO = {
    bench:   { name: "Bench",   mvt: 0.17 },
    squat:   { name: "Squat",   mvt: 0.37 },
    row:     { name: "Row",     mvt: 0.40 },
    deadlift:{ name: "Deadlift",mvt: 0.16 },
    other:   { name: "Autre",   mvt: 0.20 }
  };

  // ---------- persistence ----------
  const LS_KEY = "vbt_iphone_rows_v3";
  const LS_THEME = "vbt_iphone_theme_v1";

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) rows.push(...parsed);
      }
    }catch(e){ /* ignore */ }

    const savedTheme = localStorage.getItem(LS_THEME);
    if(savedTheme === "dark") app.setAttribute("data-theme", "dark");
  }
  function saveState(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(rows)); }catch(e){ /* ignore */ }
  }

  // ---------- UI ----------
  function setStatus(kind, text){
    statusDot.className = "dot" + (kind ? (" " + kind) : "");
    statusText.textContent = text;
  }
  function fmt(n, d=2){
    if(!isFinite(n)) return "‚Äî";
    return Number(n).toFixed(d);
  }

  // ---------- Motion capture state ----------
  let listening = false;
  let lastT = null;
  let lastMotionTs = null;

  // filters/signals
  let gSlow = 9.81;
  let aEMA = 0;
  let v = 0;

  // rep detection
  let inRep = false;
  let belowSince = null;
  let repStartT = null;
  let repV = [];
  let repA = [];
  let vPeak = 0;
  let aPeak = 0;

  // proposal (not saved until accepted)
  let pending = null;

  // saved rows
  const rows = []; // {id, exo, load, vMean, vPeak, aPeak, pMean, pPeak, dur}

  function clampDt(dt){
    if(!isFinite(dt) || dt <= 0) return 0.016;
    return Math.max(0.002, Math.min(0.08, dt));
  }
  function getParams(){
    return {
      START_THR: parseFloat(startThrEl.value) || 0.60,
      STOP_THR:  parseFloat(stopThrEl.value)  || 0.25,
      STOP_HOLD_MS: parseInt(stopHoldEl.value,10) || 250,
      DECAY_TAU: Math.max(0.05, parseFloat(decayTauEl.value) || 0.35)
    };
  }

  function readAccel(evt){
    // Prefer acceleration (without gravity) if available
    const a = evt.acceleration;
    const ag = evt.accelerationIncludingGravity;

    let ax=null, ay=null, az=null;
    if(a && (a.x!==null || a.y!==null || a.z!==null)){
      ax=a.x; ay=a.y; az=a.z;
    } else if(ag && (ag.x!==null || ag.y!==null || ag.z!==null)){
      ax=ag.x; ay=ag.y; az=ag.z;
    } else {
      return null;
    }
    if(ax===null || ay===null || az===null) return null;

    const mode = axisModeEl.value;
    let raw = 0;
    if(mode==="mag") raw = Math.sqrt(ax*ax + ay*ay + az*az);
    else if(mode==="x") raw = ax;
    else if(mode==="y") raw = ay;
    else raw = az;

    return raw;
  }

  function resetIntegrators(){
    lastT = null;
    gSlow = 9.81;
    aEMA = 0;
    v = 0;
    inRep = false;
    belowSince = null;
    repStartT = null;
    repV = [];
    repA = [];
    vPeak = 0;
    aPeak = 0;
    repStateEl.textContent = "‚Äî";
  }

  function showProposal(p){
    pending = p;
    proposalText.innerHTML =
      `<b>${EXO[p.exo].name}</b> ‚Äî <b>${fmt(p.load,1)} kg</b><br>` +
      `vÃÑ: <b>${fmt(p.vMean)}</b> m/s ¬∑ v pic: <b>${fmt(p.vPeak)}</b> m/s ¬∑ a pic: <b>${fmt(p.aPeak)}</b> m/s¬≤<br>` +
      `PÃÑ: <b>${fmt(p.pMean,0)}</b> W ¬∑ P pic: <b>${fmt(p.pPeak,0)}</b> W ¬∑ dur√©e: <b>${fmt(p.dur)}</b> s`;
    proposalBox.style.display = "block";
    vMeanLiveEl.textContent = fmt(p.vMean);
    aPeakLiveEl.textContent = fmt(p.aPeak);
  }
  function clearProposal(){
    pending = null;
    proposalBox.style.display = "none";
  }

  function startRep(now){
    inRep = true;
    repStateEl.textContent = "EN REP";
    repStartT = now;
    belowSince = null;
    repV = [];
    repA = [];
    v = 0; // reset speed per rep (reduces drift)
    vPeak = 0;
    aPeak = 0;
    // when a new rep starts, hide old proposal (optional behavior)
    clearProposal();
    setStatus("warn", "R√©p√©tition‚Ä¶");
  }

  function endRep(now){
    inRep = false;
    repStateEl.textContent = "FIN (proposition)";
    setStatus("ok", "En √©coute");

    const dur = (now - repStartT) / 1000;
    if(repV.length < 6 || dur < 0.15){
      resetIntegrators();
      return;
    }

    const vMean = repV.reduce((s,x)=>s+x,0) / repV.length;
    const vPk = Math.max(...repV);
    const aPk = Math.max(...repA);

    const load = parseFloat(loadKgEl.value) || 0;
    const forceN = load * 9.81;          // approx vertical force
    const pMean = forceN * vMean;        // W
    const pPeak = forceN * vPk;

    // "Hold" = lock on best value
    vHoldEl.textContent = fmt(vPk);

    showProposal({
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()),
      exo: exerciseEl.value,
      load,
      vMean, vPeak: vPk, aPeak: aPk,
      pMean, pPeak,
      dur
    });

    // reset for next detection (keep listening)
    repV = []; repA = [];
    v = 0; aEMA = 0; belowSince = null;
  }

  function onMotion(evt){
    lastMotionTs = performance.now();

    const now = performance.now();
    if(lastT === null) lastT = now;
    const dt = clampDt((now - lastT)/1000);
    lastT = now;

    const raw = readAccel(evt);
    if(raw === null) return;

    const p = getParams();

    // filters: slow baseline + fast smoothing
    const ALPHA_SLOW = 0.02;
    const ALPHA_FAST = 0.35;

    gSlow = (1-ALPHA_SLOW)*gSlow + ALPHA_SLOW*raw;
    const aHP = raw - gSlow;
    const aAbs = Math.abs(aHP);

    aEMA = (1-ALPHA_FAST)*aEMA + ALPHA_FAST*aAbs;

    // integrate to a scalar "speed estimate" with decay (anti drift)
    const decay = Math.exp(-dt / p.DECAY_TAU);
    v = v*decay + aEMA*dt;
    if(v < 0) v = 0;

    // during rep: update peak and "hold display" = peak
    if(inRep){
      repV.push(v);
      repA.push(aEMA);
      if(v > vPeak) vPeak = v;
      if(aEMA > aPeak) aPeak = aEMA;
      vHoldEl.textContent = fmt(vPeak); // lock on best

      // stop condition
      if(aEMA < p.STOP_THR){
        if(belowSince === null) belowSince = now;
        if((now - belowSince) > p.STOP_HOLD_MS){
          endRep(now);
        }
      } else {
        belowSince = null;
      }
    } else {
      // start condition
      if(aEMA > p.START_THR){
        startRep(now);
      }
    }
  }

  async function requestPermissionIfNeeded(){
    if(!window.isSecureContext){
      throw new Error("Page non s√©curis√©e (HTTPS requis)");
    }
    if(typeof DeviceMotionEvent !== "undefined" &&
       typeof DeviceMotionEvent.requestPermission === "function"){
      const resp = await DeviceMotionEvent.requestPermission();
      if(resp !== "granted") throw new Error("Permission refus√©e");
    }
  }

  function startListening(){
    if(listening) return;
    resetIntegrators();
    lastMotionTs = null;

    window.addEventListener("devicemotion", onMotion, { passive:true });
    listening = true;
    btnStart.disabled = true;
    btnStop.disabled = false;
    setStatus("ok", "En √©coute");
    repStateEl.textContent = "‚Äî";

    // watchdog: detect "capteur inactif"
    setTimeout(() => {
      if(!listening) return;
      if(lastMotionTs === null){
        setStatus("bad", "Capteur inactif");
        alert("Aucun signal capteur.\n\nV√©rifie : Safari (pas Chrome), HTTPS, et R√©glages iOS > Safari > Acc√®s Mouvement & Orientation (autoris√©).");
      }
    }, 1200);
  }

  function stopListening(){
    if(!listening) return;
    window.removeEventListener("devicemotion", onMotion);
    listening = false;
    btnStart.disabled = false;
    btnStop.disabled = true;
    setStatus("", "En attente");
    resetIntegrators();
  }

  // ---------- table + stats ----------
  function renderTable(){
    tbody.innerHTML = "";
    rows.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${EXO[r.exo]?.name ?? r.exo}</td>
        <td class="right">${fmt(r.load,1)}</td>
        <td class="right">${fmt(r.vMean)}</td>
        <td class="right">${fmt(r.vPeak)}</td>
        <td class="right">${fmt(r.aPeak)}</td>
        <td class="right">${fmt(r.pMean,0)}</td>
        <td class="right">${fmt(r.pPeak,0)}</td>
        <td class="right">${fmt(r.dur)}</td>
      `;
      tbody.appendChild(tr);
    });
    repCountEl.textContent = String(rows.length);
  }

  function exportCSV(){
    if(!rows.length) return;
    const header = ["n","exercise","load_kg","v_mean_ms","v_peak_ms","a_peak_ms2","p_mean_w","p_peak_w","duration_s"];
    const lines = [header.join(",")];
    rows.forEach((r,i)=>{
      lines.push([
        i+1,
        EXO[r.exo]?.name ?? r.exo,
        r.load.toFixed(2),
        r.vMean.toFixed(4),
        r.vPeak.toFixed(4),
        r.aPeak.toFixed(4),
        r.pMean.toFixed(2),
        r.pPeak.toFixed(2),
        r.dur.toFixed(4)
      ].join(","));
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `vbt_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  function computeForSelectedExercise(){
    const exo = exerciseEl.value;
    const data = rows.filter(r => r.exo === exo);

    // pMax
    if(data.length){
      let best = data[0];
      for(const r of data) if(r.pPeak > best.pPeak) best = r;
      pMaxEl.textContent = `${fmt(best.pPeak,0)} W`;
      pMaxHintEl.textContent = `√† ${fmt(best.load,1)} kg`;
    } else {
      pMaxEl.textContent = "‚Äî";
      pMaxHintEl.textContent = "";
    }

    // 1RM estimate via linear regression (load vs vMean)
    if(data.length < 2){
      oneRmEl.textContent = "‚Äî";
      oneRmHintEl.textContent = "Ajoute au moins 2 reps valid√©es (charges diff√©rentes).";
      return { data, fit:null };
    }

    // regression vMean = a + b*load (b should be negative)
    const xs = data.map(d => d.load);
    const ys = data.map(d => d.vMean);

    const n = xs.length;
    const meanX = xs.reduce((s,x)=>s+x,0)/n;
    const meanY = ys.reduce((s,y)=>s+y,0)/n;

    let num=0, den=0;
    for(let i=0;i<n;i++){
      num += (xs[i]-meanX)*(ys[i]-meanY);
      den += (xs[i]-meanX)*(xs[i]-meanX);
    }
    if(den === 0){
      oneRmEl.textContent = "‚Äî";
      oneRmHintEl.textContent = "Charges identiques : impossible de faire une r√©gression.";
      return { data, fit:null };
    }
    const b = num/den;
    const a = meanY - b*meanX;

    const mvt = Math.max(0, parseFloat(mvtEl.value) || EXO[exo].mvt);
    // solve mvt = a + b*load => load = (mvt - a)/b
    let est = (mvt - a) / b;

    if(!isFinite(est) || est < 0){
      oneRmEl.textContent = "‚Äî";
      oneRmHintEl.textContent = "Profil incoh√©rent (pente/valeurs). Ajuste MVT ou refais des points.";
      return { data, fit:{a,b,mvt,est:null} };
    }

    // cap a little if wildly beyond max load (still show)
    oneRmEl.textContent = `${fmt(est,1)} kg`;
    oneRmHintEl.textContent = `Bas√© sur vÃÑ et MVT=${fmt(mvt,2)} m/s (indicatif).`;

    return { data, fit:{a,b,mvt,est} };
  }

  // ---------- chart (dual y axis) ----------
  function clearCanvas(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }
  function drawChart(){
    clearCanvas();

    const exo = exerciseEl.value;
    const { data, fit } = computeForSelectedExercise();

    // Basic frame
    const W = canvas.width, H = canvas.height;
    const padL = 70, padR = 70, padT = 20, padB = 55;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    // axes ranges
    const xVals = data.map(d=>d.load);
    const vVals = data.map(d=>d.vMean);
    const pVals = data.map(d=>d.pMean);

    const xMin = data.length ? Math.min(...xVals) : 0;
    const xMax = data.length ? Math.max(...xVals) : 100;

    const vMax = data.length ? Math.max(1.0, ...vVals, (fit?.mvt ?? 0)) : 1.0;
    const vMin = 0;

    const pMax = data.length ? Math.max(100, ...pVals) : 100;
    const pMin = 0;

    const xToPx = (x) => padL + ( (x - xMin) / (xMax - xMin || 1) ) * plotW;
    const vToPy = (v) => padT + (1 - ( (v - vMin) / (vMax - vMin || 1) )) * plotH;
    const pToPy = (p) => padT + (1 - ( (p - pMin) / (pMax - pMin || 1) )) * plotH;

    // grid + axes
    ctx.lineWidth = 1;
    ctx.strokeStyle = getComputedStyle(app).getPropertyValue("--border").trim();
    ctx.fillStyle = getComputedStyle(app).getPropertyValue("--muted").trim();
    ctx.font = "12px system-ui";

    // border
    ctx.strokeRect(padL, padT, plotW, plotH);

    // x ticks
    const ticksX = 4;
    for(let i=0;i<=ticksX;i++){
      const t = xMin + (i/ticksX)*(xMax-xMin || 1);
      const x = xToPx(t);
      ctx.beginPath();
      ctx.moveTo(x, padT+plotH);
      ctx.lineTo(x, padT+plotH+6);
      ctx.stroke();
      ctx.fillText(String(Math.round(t)), x-8, padT+plotH+24);
    }
    // y left (velocity)
    const ticksY = 4;
    for(let i=0;i<=ticksY;i++){
      const t = vMin + (i/ticksY)*(vMax-vMin);
      const y = vToPy(t);
      ctx.beginPath();
      ctx.moveTo(padL-6, y);
      ctx.lineTo(padL, y);
      ctx.stroke();
      ctx.fillText(t.toFixed(2), 10, y+4);
    }
    // y right (power)
    for(let i=0;i<=ticksY;i++){
      const t = pMin + (i/ticksY)*(pMax-pMin);
      const y = pToPy(t);
      ctx.beginPath();
      ctx.moveTo(padL+plotW, y);
      ctx.lineTo(padL+plotW+6, y);
      ctx.stroke();
      ctx.fillText(String(Math.round(t)), padL+plotW+14, y+4);
    }

    // axis labels
    ctx.fillText("Charge (kg)", padL + plotW/2 - 30, H-16);
    ctx.fillText("Vitesse vÃÑ (m/s)", 10, 16);
    ctx.fillText("Puissance PÃÑ (W)", padL+plotW+8, 16);

    // no data
    if(!data.length){
      ctx.fillText("Ajoute des reps valid√©es pour voir le profil.", padL+20, padT+30);
      return;
    }

    // points: velocity (left axis)
    const accent = getComputedStyle(app).getPropertyValue("--accent").trim();
    const accent2 = getComputedStyle(app).getPropertyValue("--accent2").trim();

    // velocity scatter
    ctx.fillStyle = accent;
    data.forEach(d=>{
      const x = xToPx(d.load);
      const y = vToPy(d.vMean);
      ctx.beginPath();
      ctx.arc(x,y,6,0,Math.PI*2);
      ctx.fill();
    });

    // power scatter (right axis) - hollow circles
    ctx.strokeStyle = accent2;
    ctx.lineWidth = 2;
    data.forEach(d=>{
      const x = xToPx(d.load);
      const y = pToPy(d.pMean);
      ctx.beginPath();
      ctx.arc(x,y,6,0,Math.PI*2);
      ctx.stroke();
    });

    // regression line for velocity
    if(fit && fit.est !== null){
      ctx.strokeStyle = accent;
      ctx.lineWidth = 2;
      const x1 = xMin, x2 = Math.max(xMax, fit.est);
      const y1 = fit.a + fit.b*x1;
      const y2 = fit.a + fit.b*x2;
      ctx.beginPath();
      ctx.moveTo(xToPx(x1), vToPy(y1));
      ctx.lineTo(xToPx(x2), vToPy(y2));
      ctx.stroke();

      // MVT horizontal
      ctx.strokeStyle = getComputedStyle(app).getPropertyValue("--muted").trim();
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(padL, vToPy(fit.mvt));
      ctx.lineTo(padL+plotW, vToPy(fit.mvt));
      ctx.stroke();
      ctx.setLineDash([]);

      // estimated 1RM marker
      ctx.fillStyle = getComputedStyle(app).getPropertyValue("--text").trim();
      const xEst = xToPx(fit.est);
      const yMvt = vToPy(fit.mvt);
      ctx.beginPath();
      ctx.arc(xEst, yMvt, 6, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = getComputedStyle(app).getPropertyValue("--muted").trim();
      ctx.fillText(`1RM‚âà${fit.est.toFixed(1)}kg`, Math.min(xEst+8, padL+plotW-70), Math.max(yMvt-10, padT+14));
    }
  }

  // ---------- actions ----------
  btnStart.addEventListener("click", async () => {
    try{
      setStatus("warn","Autorisation‚Ä¶");
      await requestPermissionIfNeeded();
      startListening();
    }catch(e){
      console.error(e);
      setStatus("bad","Capteurs indisponibles");
      alert("Impossible d'acc√©der aux capteurs.\n\n‚úÖ V√©rifie : Safari + HTTPS (GitHub Pages), et autorise ‚ÄúMouvement & Orientation‚Äù.");
    }
  });
  btnStop.addEventListener("click", stopListening);

  btnAccept.addEventListener("click", () => {
    if(!pending) return;
    rows.push(pending);
    saveState();
    renderTable();
    drawChart();
    clearProposal();
    repStateEl.textContent = "‚Äî";
  });
  btnReject.addEventListener("click", () => {
    clearProposal();
    repStateEl.textContent = "‚Äî";
  });

  btnExport.addEventListener("click", exportCSV);
  btnUndo.addEventListener("click", () => {
    rows.pop();
    saveState();
    renderTable();
    drawChart();
  });
  btnReset.addEventListener("click", () => {
    if(!confirm("Reset : supprimer toutes les reps enregistr√©es ?")) return;
    rows.length = 0;
    saveState();
    renderTable();
    drawChart();
    clearProposal();
    vHoldEl.textContent = "0.00";
    vMeanLiveEl.textContent = "‚Äî";
    aPeakLiveEl.textContent = "‚Äî";
  });

  // exercise changes => update default MVT
  exerciseEl.addEventListener("change", () => {
    const exo = exerciseEl.value;
    mvtEl.value = String(EXO[exo]?.mvt ?? 0.20);
    drawChart();
  });
  mvtEl.addEventListener("input", drawChart);

  // theme toggle
  themeToggle.addEventListener("click", () => {
    const cur = app.getAttribute("data-theme") || "light";
    const next = cur === "light" ? "dark" : "light";
    app.setAttribute("data-theme", next);
    try{ localStorage.setItem(LS_THEME, next); }catch(e){}
    drawChart();
  });

  // init
  loadState();
  renderTable();
  setStatus("", "En attente");
  // ensure mvt matches selected exercise on load
  mvtEl.value = String(EXO[exerciseEl.value]?.mvt ?? 0.20);
  drawChart();
})();
</script>
</body>
</html>
