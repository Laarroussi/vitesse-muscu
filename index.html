<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Vitesse Muscu Mobile</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- LAYOUT --- */
    .app-header {
      padding: 15px;
      background: var(--card);
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--danger);
      display: inline-block;
    }
    .status-dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); }

    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
      overflow-y: auto;
    }

    /* --- CARDS --- */
    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    /* Settings Compact */
    .settings-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
    }
    select, input {
      background: #334155;
      border: 1px solid #475569;
      color: white;
      padding: 10px;
      border-radius: 10px;
      font-size: 16px;
      width: 100%;
      text-align: center;
    }

    /* BIG DISPLAY */
    .big-value {
      font-size: 60px;
      font-weight: 800;
      line-height: 1;
      margin: 10px 0;
      font-variant-numeric: tabular-nums;
    }
    .label {
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .sub-value {
      font-size: 18px;
      color: var(--muted);
      margin-top: 5px;
    }

    /* VALIDATION MODAL AREA */
    #validationArea {
      display: none; /* Hidden by default */
      background: rgba(30, 41, 59, 0.95);
      border: 2px solid var(--warning);
    }
    .validation-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    /* BUTTONS */
    .btn {
      border: none;
      padding: 16px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--accent); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--muted); color: var(--muted); }

    /* FOOTER / HISTORY */
    .history-toggle {
      text-align: center;
      margin-top: auto;
      padding: 15px;
    }
    details { margin-top: 10px; text-align: left; }
    summary { color: var(--accent); padding: 10px; cursor: pointer; list-style: none; text-align: center; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; color: var(--muted); }
    td, th { padding: 8px; border-bottom: 1px solid #334155; text-align: left; }
    
    /* STATES */
    .state-ready { color: var(--muted); }
    .state-moving { color: var(--accent); }
    .state-rep { color: var(--success); }

  </style>
</head>
<body>

  <div class="app-header">
    <div style="font-weight:700; font-size:18px;">Vitesse Muscu</div>
    <div id="statusInd" class="status-dot"></div>
  </div>

  <div class="main-area">

    <div class="settings-row">
      <select id="exerciseSel">
        <option value="bench">Bench Press</option>
        <option value="squat">Squat</option>
        <option value="deadlift">Deadlift</option>
      </select>
      <input type="number" id="loadKg" value="60" step="0.5" placeholder="Kg" style="width: 80px;">
    </div>

    <button id="btnEnable" class="btn btn-primary">
      Activer les capteurs
    </button>
    <div id="sensorHelp" style="font-size:12px; color:var(--muted); text-align:center; margin-top:-10px;">
      Nécessite HTTPS. Cliquez pour autoriser.
    </div>

    <div id="liveArea" class="card" style="display:none;">
      <div class="label">Vitesse Instantanée</div>
      <div class="big-value state-ready" id="vNow">0.00</div>
      <div class="sub-value">m/s</div>
      <div style="margin-top:15px; font-size:13px; color:var(--muted)">
        Place le téléphone sur la barre.<br>
        Fais ta répétition.
      </div>
    </div>

    <div id="validationArea" class="card">
      <div class="label" style="color:var(--warning)">Répétition terminée</div>
      <div class="big-value" id="valVelocity">0.00</div>
      <div class="sub-value" style="color:white">m/s</div>
      <hr style="border:0; border-top:1px solid #334155; margin:15px 0;">
      <div style="display:flex; justify-content:space-around; margin-bottom:15px;">
        <div>
          <div class="label">Puis.</div>
          <div style="font-size:18px; color:white" id="valPower">0 W</div>
        </div>
        <div>
          <div class="label">1RM Est.</div>
          <div style="font-size:18px; color:white" id="val1RM">0 kg</div>
        </div>
      </div>
      
      <div class="validation-buttons">
        <button id="btnDiscard" class="btn btn-danger">Jeter</button>
        <button id="btnKeep" class="btn btn-success">Valider</button>
      </div>
    </div>

    <div id="lastResult" class="card" style="display:none; border:1px solid var(--success);">
      <div class="label">Dernière validée</div>
      <div style="font-size:32px; font-weight:700; color:var(--success)" id="lastV">--</div>
      <div style="font-size:14px; color:var(--muted)" id="lastInfo">--</div>
    </div>

    <div class="history-toggle">
      <div style="font-size:14px; margin-bottom:5px;">Total: <span id="totalReps">0</span> reps valides</div>
      <details>
        <summary>Voir l'historique & Graphique</summary>
        <div style="background:var(--card); padding:10px; border-radius:10px; margin-top:10px;">
          <button id="btnExport" class="btn btn-outline" style="font-size:12px; padding:8px;">Exporter CSV</button>
          <br><br>
          <table id="repTable">
            <thead>
              <tr><th>Kg</th><th>m/s</th><th>W</th><th>1RM</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <br>
          <div style="font-size:12px; color:var(--muted);">
            Le calcul final du profil se fera automatiquement avec plusieurs charges différentes.
          </div>
        </div>
      </details>
    </div>

  </div>

<script>
// --- CONFIGURATION ---
const EXERCISES = {
  bench: { name: "Bench", pct: (v) => 110.89 - 64.19*v }, // SciRep 2025 approx
  squat: { name: "Squat", pct: (v) => (v > 1.3 ? 0 : 100 - v*75) }, // Simplifié linéaire pour démo
  deadlift: { name: "Deadlift", pct: (v) => 108.7 - 73.5*v }
};

// --- STATE ---
let state = {
  active: false,
  isLifting: false,
  tempRep: null, // Stores data waiting for validation
  reps: [],
  v: 0,
  aEMA: 0,
  maxV: 0,
  lastTime: 0
};

// --- DOM ELEMENTS ---
const $ = (id) => document.getElementById(id);
const els = {
  btnEnable: $('btnEnable'),
  liveArea: $('liveArea'),
  validationArea: $('validationArea'),
  lastResult: $('lastResult'),
  vNow: $('vNow'),
  valVelocity: $('valVelocity'),
  valPower: $('valPower'),
  val1RM: $('val1RM'),
  statusInd: $('statusInd'),
  tableBody: $('repTable').querySelector('tbody'),
  totalReps: $('totalReps')
};

// --- SENSOR LOGIC ---
els.btnEnable.addEventListener('click', async () => {
  // Check protocol
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert("ATTENTION : iOS bloque les capteurs si la page n'est pas en HTTPS. Veuillez héberger ce fichier.");
  }

  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    try {
      const permission = await DeviceMotionEvent.requestPermission();
      if (permission === 'granted') {
        startSensors();
      } else {
        alert("Permission refusée. Allez dans Réglages > Safari pour réinitialiser.");
      }
    } catch (e) {
      alert("Erreur: " + e);
    }
  } else {
    // Android or non-iOS 13+
    startSensors();
  }
});

function startSensors() {
  window.addEventListener('devicemotion', handleMotion, true);
  state.active = true;
  els.statusInd.classList.add('active');
  els.btnEnable.style.display = 'none';
  $('sensorHelp').style.display = 'none';
  els.liveArea.style.display = 'block';
}

function handleMotion(event) {
  if (!state.active) return;
  if (state.tempRep) return; // Paused while waiting for validation

  // Get Accel (remove gravity roughly)
  let ax = event.acceleration.x || 0;
  let ay = event.acceleration.y || 0;
  let az = event.acceleration.z || 0;

  // Fallback for some androids using accelerationIncludingGravity
  if (!event.acceleration.x && event.accelerationIncludingGravity) {
     // Very crude gravity removal filter
     ax = event.accelerationIncludingGravity.x;
     ay = event.accelerationIncludingGravity.y;
     az = event.accelerationIncludingGravity.z - 9.81; 
  }

  const a = Math.sqrt(ax*ax + ay*ay + az*az);
  
  // Smoothing
  state.aEMA = state.aEMA * 0.8 + a * 0.2;
  
  // Integration (Simple Euler)
  const now = performance.now();
  const dt = (now - state.lastTime) / 1000;
  state.lastTime = now;
  if (dt > 1) return; // skip glitches

  // Thresholds
  const START_ACC = 2.0; // m/s² to start rep
  const STOP_ACC = 1.0;  // m/s² to stop rep
  const DRAG = 0.5;      // Friction to prevent drift

  if (state.aEMA > START_ACC) {
    state.v += state.aEMA * dt;
    state.isLifting = true;
    els.vNow.className = "big-value state-rep";
  } else {
    state.v -= DRAG * dt; // decay
    if (state.v < 0) state.v = 0;
    
    // Check end of rep
    if (state.isLifting && state.v < 0.1 && state.aEMA < STOP_ACC) {
      finishRep();
    }
    els.vNow.className = "big-value state-ready";
  }

  // Record Peak Velocity
  if (state.isLifting) {
    if (state.v > state.maxV) state.maxV = state.v;
  }

  // Update UI
  els.vNow.textContent = state.v.toFixed(2);
}

function finishRep() {
  state.isLifting = false;
  
  // Ignore minimal movements (noise)
  if (state.maxV < 0.15) {
    state.maxV = 0;
    state.v = 0;
    return;
  }

  // PREPARE VALIDATION DATA
  const load = parseFloat($('loadKg').value);
  const ex = $('exerciseSel').value;
  
  // Estimates
  const pwr = load * 9.81 * state.maxV; // Ppeak approx
  const pct = EXERCISES[ex].pct(state.maxV);
  const est1rm = (pct > 0 && pct <= 100) ? (load / (pct/100)) : 0;

  state.tempRep = {
    velocity: state.maxV,
    power: pwr,
    est1rm: est1rm,
    load: load,
    exercise: EXERCISES[ex].name
  };

  // SHOW VALIDATION UI
  els.liveArea.style.display = 'none';
  els.validationArea.style.display = 'block';
  
  els.valVelocity.textContent = state.maxV.toFixed(2);
  els.valPower.textContent = pwr.toFixed(0) + " W";
  els.val1RM.textContent = est1rm > 0 ? est1rm.toFixed(0) + " kg" : "—";
}

// --- VALIDATION ACTIONS ---

$('btnKeep').addEventListener('click', () => {
  if (!state.tempRep) return;
  
  // 1. Add to history
  state.reps.push(state.tempRep);
  updateHistoryTable(state.tempRep);
  
  // 2. Update summary UI
  els.lastResult.style.display = 'block';
  $('lastV').textContent = state.tempRep.velocity.toFixed(2) + " m/s";
  $('lastInfo').textContent = `${state.tempRep.load}kg • ${state.tempRep.est1rm.toFixed(0)}kg 1RM`;
  
  els.totalReps.textContent = state.reps.length;

  resetAfterValidation();
});

$('btnDiscard').addEventListener('click', () => {
  resetAfterValidation();
});

function resetAfterValidation() {
  state.tempRep = null;
  state.v = 0;
  state.maxV = 0;
  state.aEMA = 0;
  
  els.validationArea.style.display = 'none';
  els.liveArea.style.display = 'block';
  els.vNow.textContent = "0.00";
}

function updateHistoryTable(rep) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${rep.load}</td>
    <td><strong>${rep.velocity.toFixed(2)}</strong></td>
    <td>${rep.power.toFixed(0)}</td>
    <td>${rep.est1rm > 0 ? rep.est1rm.toFixed(0) : '-'}</td>
  `;
  // Add to top
  els.tableBody.prepend(tr);
}

// --- EXPORT ---
$('btnExport').addEventListener('click', () => {
  let csvContent = "data:text/csv;charset=utf-8,Exercise,Load,Velocity,Power,Est1RM\n";
  state.reps.forEach(r => {
    csvContent += `${r.exercise},${r.load},${r.velocity.toFixed(2)},${r.power.toFixed(0)},${r.est1rm.toFixed(0)}\n`;
  });
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "vitesse_muscu_data.csv");
  document.body.appendChild(link);
  link.click();
});

</script>
</body>
</html>
