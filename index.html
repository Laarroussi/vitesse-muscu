<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>VBT iPhone â€” Pro</title>
  <style>
    :root{
      --bg:#f8f9fc; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --border:#e2e8f0; --accent:#3b82f6; --accent2:#0ea5e9;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8;
      --border:#334155; --accent:#60a5fa; --accent2:#38bdf8;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    body{ margin:0; background:var(--bg); color:var(--text); transition: background 0.3s, color 0.3s; }
    .wrap{ max-width:1000px; margin:0 auto; padding:16px; padding-bottom:40px; }
    
    /* Header */
    header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:16px; }
    h1{ font-size:18px; margin:0 0 4px; font-weight:800; letter-spacing:-0.5px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.4; }
    
    /* Cards */
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:20px; padding:16px; box-shadow:var(--shadow);
      margin-bottom:16px; transition: background 0.3s, border-color 0.3s;
    }

    /* Grids */
    .row{ display:grid; gap:16px; grid-template-columns:1fr; }
    @media (min-width: 860px){ .row{ grid-template-columns: 1.2fr 0.8fr; } }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }

    /* Inputs & Buttons */
    button{
      border:0; border-radius:12px; padding:12px 16px;
      font-weight:600; cursor:pointer; font-size:14px;
      background:var(--accent); color:white; transition: transform 0.1s, opacity 0.2s;
    }
    button:active{ transform:scale(0.98); }
    button.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); }
    button.danger{ background:var(--bad); color:white; }
    button:disabled{ opacity:0.5; cursor:not-allowed; }
    
    label{ display:block; font-size:12px; font-weight:600; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
    input, select{
      width:100%; box-sizing:border-box; background:var(--bg); color:var(--text);
      border:1px solid var(--border); border-radius:12px;
      padding:12px; font-size:15px; outline:none; appearance:none;
    }
    input:focus, select:focus{ border-color:var(--accent); ring:2px var(--accent); }

    /* Metrics */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 12px; border-radius:20px;
      border:1px solid var(--border); background:var(--bg); color:var(--muted); font-weight:500;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:#cbd5e1; }
    .dot.ok{ background:var(--ok); box-shadow: 0 0 8px var(--ok); }
    .dot.warn{ background:var(--warn); box-shadow: 0 0 8px var(--warn); }
    .dot.bad{ background:var(--bad); }

    .metricBig{
      text-align:center; padding:20px; border-radius:20px;
      background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(59,130,246,0.01) 100%);
      border:1px solid var(--border);
    }
    .metricBig .k{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; }
    .metricBig .v{ font-size:56px; font-weight:900; letter-spacing:-2px; line-height:1; font-variant-numeric: tabular-nums; }
    .metricBig .u{ font-size:16px; color:var(--muted); font-weight:500; margin-left:4px; }

    .metricSmall{
      border:1px solid var(--border); border-radius:16px; padding:12px;
      background:var(--bg); text-align:center;
    }
    .metricSmall .k{ font-size:11px; color:var(--muted); margin-bottom:4px; }
    .metricSmall .v{ font-size:20px; font-weight:700; font-variant-numeric: tabular-nums; }

    /* Proposal Box */
    .proposal{
      border:2px solid var(--accent); border-radius:16px; padding:16px;
      background:var(--bg); margin-top:16px; animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    .proposal h2{ margin:0 0 10px; font-size:14px; color:var(--accent); font-weight:bold; }
    
    /* Chart */
    .canvasWrap{ position:relative; width:100%; height:300px; margin-top:16px; }
    canvas{ width:100%; height:100%; }

    /* Table */
    table{ width:100%; border-collapse:collapse; margin-top:16px; font-size:13px; }
    th{ text-align:left; color:var(--muted); font-weight:600; padding:8px; border-bottom:1px solid var(--border); }
    td{ padding:8px; border-bottom:1px solid var(--border); color:var(--text); }
    .right{ text-align:right; }

    /* Theme Toggle */
    .toggle{
      cursor:pointer; padding:8px 12px; border-radius:20px;
      background:var(--card); border:1px solid var(--border);
      font-size:14px; user-select:none;
    }

    details summary { padding: 10px 0; font-weight: 600; cursor: pointer; }
  </style>
</head>

<body>
<div class="wrap" id="app" data-theme="light">
  
  <header>
    <div>
      <h1>VBT iPhone Pro</h1>
      <div class="muted">Mesure de vitesse de barre & estimation 1RM.</div>
    </div>
    <div class="toggle" id="themeToggle">ðŸŒ— ThÃ¨me</div>
  </header>

  <div class="row">
    <div class="card">
      <div class="btnRow">
        <button id="btnStart">DÃ©marrer</button>
        <button id="btnStop" class="secondary" disabled>Stop</button>
        <span class="pill"><span id="statusDot" class="dot"></span><span id="statusText">En attente</span></span>
        <span class="pill">Reps : <b id="repCount">0</b></span>
      </div>

      <div class="metricBig">
        <div class="k">Vitesse Pic (Rep)</div>
        <div><span class="v" id="vHold">0.00</span><span class="u">m/s</span></div>
      </div>

      <div class="grid3" style="margin-top:16px;">
        <div class="metricSmall">
          <div class="k">Vitesse Moy</div>
          <div class="v" id="vMeanLive">â€”</div>
        </div>
        <div class="metricSmall">
          <div class="k">Accel Pic</div>
          <div class="v" id="aPeakLive">â€”</div>
        </div>
        <div class="metricSmall">
          <div class="k">Ã‰tat</div>
          <div class="v" id="repState">â€”</div>
        </div>
      </div>

      <div id="proposalBox" class="proposal" style="display:none;">
        <h2>Nouvelle rÃ©pÃ©tition dÃ©tectÃ©e</h2>
        <div id="proposalText" class="muted" style="margin-bottom:12px; font-size:14px;"></div>
        <div class="grid2">
          <button id="btnReject" class="secondary" style="border-color:var(--bad); color:var(--bad);">Ignorer</button>
          <button id="btnAccept">Valider & Enregistrer</button>
        </div>
      </div>

      <div class="muted" style="margin-top:16px; font-size:11px; text-align:center;">
        NÃ©cessite Safari sur iOS + HTTPS. Fixez le tÃ©lÃ©phone solidement Ã  la barre.
      </div>
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label for="exercise">Exercice</label>
          <select id="exercise">
            <option value="bench">Bench Press</option>
            <option value="squat">Back Squat</option>
            <option value="deadlift">Deadlift</option>
            <option value="row">Pendlay Row</option>
            <option value="ohp">Overhead Press</option>
          </select>
        </div>
        <div>
          <label for="loadKg">Charge (kg)</label>
          <input type="number" id="loadKg" value="20" step="2.5" min="0" />
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="metricSmall" style="background:var(--card);">
          <div class="k">1RM EstimÃ©e</div>
          <div class="v" id="oneRm">â€”</div>
          <div class="k" id="oneRmHint" style="font-size:9px; margin-top:2px;"></div>
        </div>
        <div class="metricSmall" style="background:var(--card);">
          <div class="k">Puissance Max</div>
          <div class="v" id="pMax">â€”</div>
          <div class="k" id="pMaxHint" style="font-size:9px; margin-top:2px;"></div>
        </div>
      </div>

      <div class="canvasWrap">
        <canvas id="chart"></canvas>
      </div>

      <details style="margin-top:16px;">
        <summary>Historique & Options</summary>
        
        <div class="grid2" style="margin-top:10px;">
           <div>
             <label>Seuil DÃ©but (m/sÂ²)</label>
             <input type="number" id="startThr" value="0.60" step="0.1" />
           </div>
           <div>
             <label>Seuil Fin (m/sÂ²)</label>
             <input type="number" id="stopThr" value="0.25" step="0.05" />
           </div>
        </div>
        
        <div class="grid3" style="margin-top:10px;">
           <label style="grid-column: span 3; margin-bottom:0;">RÃ©glages AvancÃ©s</label>
           <input type="number" id="stopHold" value="250" placeholder="Hold ms" title="Temps maintien arrÃªt" />
           <input type="number" id="decayTau" value="0.35" step="0.05" placeholder="Decay" title="Facteur lissage" />
           <input type="number" id="mvt" value="0.17" step="0.01" placeholder="MVT" title="Vitesse Ã  1RM" />
        </div>
        <div class="muted" style="font-size:10px; margin-top:4px;">Hold (ms) / Decay (s) / MVT (m/s)</div>

        <div class="btnRow" style="margin-top:16px;">
          <button id="btnUndo" class="secondary" style="font-size:12px;">Annuler derniÃ¨re</button>
          <button id="btnExport" class="secondary" style="font-size:12px;">CSV</button>
          <button id="btnReset" class="danger" style="font-size:12px;">Tout effacer</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th><th>Exo</th><th class="right">Kg</th>
              <th class="right">V<sub>moy</sub></th><th class="right">V<sub>pic</sub></th><th class="right">Watt</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </details>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // --- STATE ---
  let listening = false;
  let lastT = null;
  let lastMotionTs = null; // Watchdog timestamp

  // Filters & Integrators
  let gSlow = 9.81; 
  let aEMA = 0;
  let v = 0;
  
  // Rep logic
  let inRep = false;
  let belowSince = null;
  let repStartT = null;
  let repV = [];
  let repA = [];
  let vPeak = 0;
  let aPeak = 0;
  
  let pending = null; // Proposal waiting
  const rows = [];    // Saved data

  // Defaults
  const EXO_DEFAULTS = {
    bench: { mvt: 0.17 }, squat: { mvt: 0.30 }, deadlift: { mvt: 0.15 }, 
    row: { mvt: 0.35 }, ohp: { mvt: 0.20 }
  };

  // --- UI ELEMENTS ---
  const ui = {
    btnStart: $('btnStart'), btnStop: $('btnStop'),
    btnAccept: $('btnAccept'), btnReject: $('btnReject'),
    btnExport: $('btnExport'), btnUndo: $('btnUndo'), btnReset: $('btnReset'),
    themeToggle: $('themeToggle'),
    statusDot: $('statusDot'), statusText: $('statusText'),
    repCount: $('repCount'), vHold: $('vHold'),
    vMeanLive: $('vMeanLive'), aPeakLive: $('aPeakLive'), repState: $('repState'),
    proposalBox: $('proposalBox'), proposalText: $('proposalText'),
    tbody: $('tbody'), chart: $('chart'),
    ex: $('exercise'), load: $('loadKg'), mvt: $('mvt'),
    startThr: $('startThr'), stopThr: $('stopThr'), 
    stopHold: $('stopHold'), decayTau: $('decayTau'),
    oneRm: $('oneRm'), oneRmHint: $('oneRmHint'),
    pMax: $('pMax'), pMaxHint: $('pMaxHint'),
    app: $('app')
  };

  // --- PERSISTENCE ---
  const LS_DATA = "vbt_data_v4";
  const LS_THEME = "vbt_theme";

  function save(){ try{ localStorage.setItem(LS_DATA, JSON.stringify(rows)); }catch(e){} }
  function load(){
    try{
      const d = JSON.parse(localStorage.getItem(LS_DATA));
      if(Array.isArray(d)) rows.push(...d);
    }catch(e){}
    const t = localStorage.getItem(LS_THEME);
    if(t) ui.app.setAttribute('data-theme', t);
  }

  // --- HELPERS ---
  function fmt(n, d=2) { return isFinite(n) ? Number(n).toFixed(d) : "â€”"; }
  function setStatus(k, t) { ui.statusDot.className = "dot "+k; ui.statusText.textContent = t; }

  // --- MOTION PROCESSING ---
  function resetIntegrators(){
    lastT = null; gSlow = 9.81; aEMA = 0; v = 0;
    inRep = false; belowSince = null; repV = []; repA = [];
    vPeak = 0; aPeak = 0;
    ui.repState.textContent = "â€”";
  }

  function onMotion(e){
    lastMotionTs = performance.now();
    const now = performance.now();
    if(lastT===null) lastT = now;
    const dt = Math.max(0.002, Math.min(0.08, (now - lastT)/1000));
    lastT = now;

    // Read Accel (Prefer no gravity)
    const accObj = e.acceleration || e.accelerationIncludingGravity;
    if(!accObj) return;
    
    // Simple magnitude (robust to orientation changes)
    const {x,y,z} = accObj;
    if(x==null) return;
    const raw = Math.sqrt(x*x + y*y + z*z);

    // High Pass Filter (Remove gravity drift)
    gSlow = gSlow * 0.98 + raw * 0.02;
    const aAbs = Math.abs(raw - gSlow);

    // Smoothing
    aEMA = aEMA * 0.65 + aAbs * 0.35;

    // Integration
    const tau = parseFloat(ui.decayTau.value) || 0.35;
    const decay = Math.exp(-dt / tau);
    v = v * decay + aEMA * dt;
    if(v < 0) v = 0;

    // --- REP LOGIC ---
    const startThr = parseFloat(ui.startThr.value) || 0.6;
    const stopThr = parseFloat(ui.stopThr.value) || 0.25;
    const stopHold = parseInt(ui.stopHold.value) || 250;

    if(inRep){
      repV.push(v); repA.push(aEMA);
      if(v > vPeak) vPeak = v;
      if(aEMA > aPeak) aPeak = aEMA;
      ui.vHold.textContent = fmt(vPeak);

      if(aEMA < stopThr){
        if(belowSince === null) belowSince = now;
        if(now - belowSince > stopHold) endRep(now);
      } else {
        belowSince = null;
      }
    } else {
      if(aEMA > startThr) startRep(now);
    }
  }

  function startRep(now){
    inRep = true; repStartT = now; belowSince = null;
    repV = []; repA = []; v = 0; vPeak = 0;
    ui.repState.textContent = "EN COURS";
    ui.proposalBox.style.display = "none";
    setStatus("warn", "Mesure...");
  }

  function endRep(now){
    inRep = false; ui.repState.textContent = "FINIE";
    setStatus("ok", "En Ã©coute");
    
    const dur = (now - repStartT)/1000;
    // Filter noise (too short reps)
    if(dur < 0.2 || repV.length < 5) return;

    const vMean = repV.reduce((a,b)=>a+b,0)/repV.length;
    const load = parseFloat(ui.load.value)||0;
    // Power = Force(mg) * Velocity. Simplified.
    const pMean = (load * 9.81) * vMean;
    const pPeak = (load * 9.81) * vPeak;

    pending = {
      id: Date.now(),
      exo: ui.ex.value,
      load, vMean, vPeak, aPeak: Math.max(...repA),
      pMean, pPeak, dur
    };

    ui.proposalText.innerHTML = `
      <b>${pending.exo.toUpperCase()} @ ${pending.load}kg</b><br>
      V.Moy: <b>${fmt(vMean)}</b> m/s &nbsp;|&nbsp; V.Pic: <b>${fmt(vPeak)}</b> m/s &nbsp;|&nbsp; P.Moy: <b>${fmt(pMean,0)}</b> W
    `;
    ui.proposalBox.style.display = "block";
    ui.vMeanLive.textContent = fmt(vMean);
    ui.aPeakLive.textContent = fmt(pending.aPeak);
  }

  // --- ANALYSIS & CHART ---
  function updateAnalysis(){
    const ex = ui.ex.value;
    const data = rows.filter(r => r.exo === ex);
    
    // Table
    ui.tbody.innerHTML = rows.map((r,i) => `
      <tr>
        <td>${i+1}</td>
        <td>${r.exo}</td>
        <td class="right">${r.load}</td>
        <td class="right">${fmt(r.vMean)}</td>
        <td class="right">${fmt(r.vPeak)}</td>
        <td class="right">${fmt(r.pMean,0)}</td>
      </tr>
    `).reverse().join(''); // Show newest first
    ui.repCount.textContent = rows.length;

    // Power Max
    if(data.length){
      const best = data.reduce((p,c) => p.pMean > c.pMean ? p : c);
      ui.pMax.textContent = fmt(best.pMean, 0) + " W";
      ui.pMaxHint.textContent = `@ ${best.load}kg`;
    } else {
      ui.pMax.textContent = "â€”"; ui.pMaxHint.textContent = "";
    }

    // 1RM Calculation (Linear Regression)
    if(data.length >= 2){
      // Filter out weird data points where slope might break
      const xs = data.map(d=>d.load);
      const ys = data.map(d=>d.vMean);
      
      const n = xs.length;
      const sx = xs.reduce((a,b)=>a+b,0);
      const sy = ys.reduce((a,b)=>a+b,0);
      const sxy = xs.reduce((a,c,i)=>a + c*ys[i],0);
      const sxx = xs.reduce((a,b)=>a + b*b,0);
      
      const denominator = (n*sxx - sx*sx);
      if(denominator !== 0){
        const b = (n*sxy - sx*sy) / denominator; // Slope
        const a = (sy - b*sx) / n; // Intercept
        
        // Safety: Velocity MUST decrease as load increases (slope b must be negative)
        if(b < 0) {
           const targetMVT = parseFloat(ui.mvt.value) || 0.2;
           const est1rm = (targetMVT - a) / b;
           if(est1rm > 0 && est1rm < 500) {
             ui.oneRm.textContent = fmt(est1rm, 1) + " kg";
             ui.oneRmHint.textContent = `MVT: ${targetMVT} m/s`;
             drawChart(data, {a, b, est1rm, targetMVT});
             return;
           }
        }
      }
    }
    ui.oneRm.textContent = "â€”";
    ui.oneRmHint.textContent = "Besoin de + de donnÃ©es";
    drawChart(data, null);
  }

  function drawChart(data, fit){
    const ctx = ui.chart.getContext('2d');
    const w = ui.chart.width = ui.chart.clientWidth;
    const h = ui.chart.height = ui.chart.clientHeight;
    ctx.clearRect(0,0,w,h);
    
    if(!data.length) {
      ctx.fillStyle = "#94a3b8"; ctx.font = "14px sans-serif";
      ctx.fillText("Aucune donnÃ©e pour cet exercice", 20, 30);
      return;
    }

    // Ranges (Add padding so dots aren't on edges)
    const xs = data.map(d=>d.load);
    const ys = data.map(d=>d.vMean);
    const minX = Math.min(...xs) - 5; 
    const maxX = Math.max(...xs, fit?.est1rm || 0) + 5;
    const minY = 0;
    const maxY = Math.max(...ys, 1.2);

    const mapX = (x) => 40 + ((x-minX)/(maxX-minX)) * (w-50);
    const mapY = (y) => (h-30) - ((y-minY)/(maxY-minY)) * (h-40);

    // Grid & Axes
    ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(40, h-30); ctx.lineTo(w-10, h-30); // X axis
    ctx.moveTo(40, h-30); ctx.lineTo(40, 10);     // Y axis
    ctx.stroke();

    // Regression Line
    if(fit){
      ctx.strokeStyle = "#94a3b8"; ctx.setLineDash([5,5]);
      ctx.beginPath();
      // Point A (minX)
      ctx.moveTo(mapX(minX), mapY(fit.a + fit.b*minX));
      // Point B (1RM)
      ctx.lineTo(mapX(fit.est1rm), mapY(fit.targetMVT));
      ctx.stroke();
      ctx.setLineDash([]);
      
      // 1RM Dot
      ctx.fillStyle = "#f59e0b";
      ctx.beginPath(); ctx.arc(mapX(fit.est1rm), mapY(fit.targetMVT), 5, 0, Math.PI*2); ctx.fill();
    }

    // Data Points
    ctx.fillStyle = "#3b82f6";
    data.forEach(d => {
      ctx.beginPath();
      ctx.arc(mapX(d.load), mapY(d.vMean), 6, 0, Math.PI*2);
      ctx.fill();
    });
  }

  // --- HANDLERS ---
  async function startListening(){
    try {
      if(DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function'){
        await DeviceMotionEvent.requestPermission();
      }
      listening = true;
      resetIntegrators();
      window.addEventListener('devicemotion', onMotion, {passive:true});
      ui.btnStart.disabled = true; ui.btnStop.disabled = false;
      setStatus("ok", "Capteurs actifs");

      // Watchdog: check if sensors actually work
      setTimeout(() => {
        if(listening && !lastMotionTs) alert("Attention : Aucun signal reÃ§u.\nVÃ©rifiez que vous Ãªtes en HTTPS et non en mode Navigation PrivÃ©e.");
      }, 2000);

    } catch(e) { alert("Erreur capteurs: "+e); }
  }

  function stopListening(){
    listening = false;
    window.removeEventListener('devicemotion', onMotion);
    ui.btnStart.disabled = false; ui.btnStop.disabled = true;
    setStatus("", "ArrÃªtÃ©");
  }

  ui.btnStart.onclick = startListening;
  ui.btnStop.onclick = stopListening;
  
  ui.btnAccept.onclick = () => {
    if(pending) rows.push(pending);
    ui.proposalBox.style.display = "none";
    ui.repState.textContent = "ENREGISTRÃ‰";
    save(); updateAnalysis();
  };
  
  ui.btnReject.onclick = () => {
    ui.proposalBox.style.display = "none";
    ui.repState.textContent = "IGNORÃ‰";
  };

  ui.btnReset.onclick = () => {
    if(confirm("Tout effacer ?")) { rows.length=0; save(); updateAnalysis(); }
  };
  ui.btnUndo.onclick = () => {
    rows.pop(); save(); updateAnalysis();
  };

  ui.btnExport.onclick = () => {
    const csv = "Exo,Kg,Vmean,Vpeak,Watt\n" + rows.map(r=>`${r.exo},${r.load},${fmt(r.vMean)},${fmt(r.vPeak)},${fmt(r.pMean,0)}`).join("\n");
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='vbt_export.csv';
    a.click();
  };

  ui.themeToggle.onclick = () => {
    const next = ui.app.getAttribute('data-theme')==='dark'?'light':'dark';
    ui.app.setAttribute('data-theme', next);
    localStorage.setItem(LS_THEME, next);
  };

  ui.ex.onchange = () => {
    // Update default MVT for exercise
    if(EXO_DEFAULTS[ui.ex.value]) ui.mvt.value = EXO_DEFAULTS[ui.ex.value].mvt;
    updateAnalysis();
  };
  
  [ui.load, ui.mvt].forEach(e => e.oninput = updateAnalysis);

  // Init
  load();
  if(EXO_DEFAULTS[ui.ex.value]) ui.mvt.value = EXO_DEFAULTS[ui.ex.value].mvt;
  updateAnalysis();
  
})();
</script>
</body>
</html>
